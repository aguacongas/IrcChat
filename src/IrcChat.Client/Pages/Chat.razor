@* src/IrcChat.Client/Pages/Chat.razor *@
@page "/chat"
@using IrcChat.Client.Models
@using IrcChat.Shared.Models
@using IrcChat.Client.Services
@using IrcChat.Client.Components
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Options
@using System.Net.Http.Headers
@inject HttpClient Http
@inject IChatService ChatService
@inject IUnifiedAuthService Auth
@inject IPrivateMessageService PrivateMessageService
@inject NavigationManager Navigation
@inject IOptions<ApiSettings> ApiSettingsOptions
@inject ILogger<Chat> Logger
@inject IDeviceDetectorService DeviceDetector
@implements IAsyncDisposable

<PageTitle>IRC Chat</PageTitle>

@if (!isInitialized)
{
    <div class="loading">
        <div class="spinner"></div>
        <p>Chargement...</p>
    </div>
}
else if (!Auth.HasUsername)
{
    <p>Redirection vers la page de connexion...</p>
}
else
{
    <SidebarToggleButton IsOpen="sidebarOpen"
                         UnreadCount="totalUnreadCount"
                         OnToggle="HandleSidebarToggle" />

    <div class="chat-container @(sidebarOpen ? "sidebar-open" : "sidebar-closed")">
        <Sidebar IsOpen="sidebarOpen"
                 Username="@currentUsername"
                 AvatarUrl="@avatarUrl"
                 IsOAuthUser="@Auth.IsReserved"
                 IsAdmin="@Auth.IsAdmin"
                 CurrentChannel="@currentChannel"
                 Channels="@channels"
                 Users="@users"
                 PrivateConversations="@privateConversations"
                 SelectedPrivateUser="@selectedPrivateUser"
                 OnChannelSelected="SwitchChannel"
                 OnUserClicked="OpenPrivateChat"
                 OnPrivateConversationSelected="OpenPrivateChat"
                 OnConversationDeleted="DeleteConversation"
                 OnUserInfoClicked="GoToSettings"
                 OnChannelDeleted="HandleChannelDeleted" />

        <ChatArea Username="@currentUsername"
                  CurrentChannel="@GetCurrentChannelOrUsername()"
                  IsConnected="@isConnected"
                  Messages="@GetCurrentMessages()"
                  Users="@(isPrivateConversation ? null : users)"
                  IsMuted="@isCurrentChannelMuted"
                  CanManage="@CanManageCurrentChannel()"
                  UsersListOpen="@usersListOpen"
                  IsPrivateConversation="@isPrivateConversation"
                  OnMessageSent="@(isPrivateConversation ? SendPrivateMessage : SendMessage)"
                  OnUserClicked="HandleUserClicked"
                  OnMuteStatusChanged="HandleMuteStatusChanged"
                  OnClosePrivateConversation="ClosePrivateChat"
                  OnChannelDeleted="HandleChannelDeleted"
                  OnUsersListToggle="HandleUsersListToggle" />
    </div>

    @if (!string.IsNullOrEmpty(muteNotification))
    {
        <div class="mute-notification">
            @muteNotification
        </div>
    }
}

@code {
    private string currentChannel = "";
    private string currentUsername = "";
    private string? avatarUrl = null;
    private List<Message> messages = new();
    private List<Channel> channels = new();
    private List<User> users = new();
    private bool isConnected = false;
    private bool isInitialized = false;
    private bool isCurrentChannelMuted = false;
    private string muteNotification = "";
    private bool sidebarOpen = false;
    private bool usersListOpen = false;
    private int totalUnreadCount => privateConversations.Sum(c => c.UnreadCount);

    // Messages privés
    private List<PrivateConversation> privateConversations = new();
    private List<PrivateMessage> privateMessages = new();
    private string? selectedPrivateUser = null;
    private bool isPrivateConversation = false;

    protected override async Task OnInitializedAsync()
    {
        await Auth.InitializeAsync();
        isInitialized = true;

        if (!Auth.HasUsername)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        currentUsername = Auth.Username!;
        avatarUrl = Auth.AvatarUrl;

        if (!string.IsNullOrEmpty(currentUsername))
        {
            if (Auth.IsAuthenticated && !string.IsNullOrEmpty(Auth.Token))
            {
                Http.DefaultRequestHeaders.Authorization =
                    new AuthenticationHeaderValue("Bearer", Auth.Token);
            }

            await LoadChannels();
            await InitializeSignalR();
            await LoadPrivateConversations();
        }
    }

    private async Task InitializeSignalR()
    {
        ChatService.OnMessageReceived += OnMessageReceived;
        ChatService.OnUserJoined += OnUserJoined;
        ChatService.OnUserLeft += OnUserLeft;
        ChatService.OnUserListUpdated += OnUserListUpdated;
        ChatService.OnChannelDeleted += OnChannelDeleted;
        ChatService.OnChannelNotFound += OnChannelNotFound;
        ChatService.OnChannelListUpdated += OnChannelListUpdated;

        PrivateMessageService.OnPrivateMessageReceived += OnPrivateMessageReceived;
        PrivateMessageService.OnPrivateMessageSent += OnPrivateMessageSent;
        PrivateMessageService.OnUnreadCountChanged += OnUnreadCountChanged;
        PrivateMessageService.OnConversationDeleted += OnConversationDeleted;

        try
        {
            var apiSettings = ApiSettingsOptions.Value;
            var hubUrl = !string.IsNullOrEmpty(apiSettings.SignalRHubUrl)
              ? apiSettings.SignalRHubUrl
              : $"{apiSettings.BaseUrl}/chathub";

            var hubConnectionBuilder = new HubConnectionBuilder()
                .WithUrl(hubUrl, options =>
                {
                    options.AccessTokenProvider = () => Task.FromResult(Auth.Token);
                })
                .WithAutomaticReconnect();
            await ChatService.InitializeAsync(hubConnectionBuilder);
            isConnected = true;

            ChatService.OnChannelMuteStatusChanged += OnChannelMuteStatusChanged;
            ChatService.OnMessageBlocked += OnMessageBlocked;

            StateHasChanged();
        }
        catch
        {
            isConnected = false;
        }
    }

    // Handlers pour canaux publics
    private void OnMessageReceived(Message message)
    {
        if (message.Channel == currentChannel && !isPrivateConversation)
        {
            messages.Add(message);
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserJoined(string user, string channel)
    {
        if (channel == currentChannel && !isPrivateConversation)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserLeft(string user, string channel)
    {
        if (channel == currentChannel && !isPrivateConversation)
        {
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnUserListUpdated(List<User> updatedUsers)
    {
        users = updatedUsers;
        InvokeAsync(StateHasChanged);
    }

    private void OnChannelMuteStatusChanged(string channel, bool isMuted)
    {
        if (channel == currentChannel && !isPrivateConversation)
        {
            isCurrentChannelMuted = isMuted;
            InvokeAsync(StateHasChanged);
        }
    }

    private void OnMessageBlocked(string reason)
    {
        muteNotification = reason;
        InvokeAsync(async () =>
        {
            StateHasChanged();
            await Task.Delay(4000);
            muteNotification = "";
            StateHasChanged();
        });
    }

    private async void OnChannelDeleted(string channelName)
    {
        channels = channels.Where(c => c.Name != channelName).ToList();

        if (currentChannel == channelName && !isPrivateConversation)
        {
            currentChannel = "";
            messages.Clear();
        }

        await InvokeAsync(StateHasChanged);
    }

    private void OnChannelNotFound(string channelName)
    {
        muteNotification = $"Le canal #{channelName} n'existe plus";
        InvokeAsync(async () =>
        {
            StateHasChanged();
            await Task.Delay(4000);
            muteNotification = "";
            StateHasChanged();
        });
    }

    private async void OnChannelListUpdated()
    {
        await LoadChannels();
        await InvokeAsync(StateHasChanged);
    }

    private Task HandleChannelDeleted(string channelName)
    {
        OnChannelDeleted(channelName);
        return Task.CompletedTask;
    }

    // Handlers pour messages privés
    private void OnPrivateMessageReceived(PrivateMessage message)
    {
        if (isPrivateConversation &&
            (message.SenderUsername == selectedPrivateUser || message.RecipientUsername == selectedPrivateUser))
        {
            privateMessages.Add(message);

            if (message.SenderUsername == selectedPrivateUser)
            {
                _ = ChatService.MarkPrivateMessagesAsRead(selectedPrivateUser!);
            }
        }

        InvokeAsync(async () =>
        {
            await LoadPrivateConversations();
            StateHasChanged();
        });
    }

    private void OnPrivateMessageSent(PrivateMessage message)
    {
        if (isPrivateConversation && message.RecipientUsername == selectedPrivateUser)
        {
            privateMessages.Add(message);
        }

        InvokeAsync(async () =>
        {
            await LoadPrivateConversations();
            StateHasChanged();
        });
    }

    private void OnUnreadCountChanged()
    {
        InvokeAsync(async () =>
        {
            await LoadPrivateConversations();
            StateHasChanged();
        });
    }

    private void OnConversationDeleted(string username)
    {
        if (selectedPrivateUser == username && isPrivateConversation)
        {
            ClosePrivateChat();
        }

        InvokeAsync(async () =>
        {
            await LoadPrivateConversations();
            StateHasChanged();
        });
    }

    // Actions
    private void GoToSettings()
    {
        Navigation.NavigateTo("/settings");
    }

    private async Task SwitchChannel(string channel)
    {
        if (!string.IsNullOrEmpty(currentChannel) && !isPrivateConversation)
        {
            await ChatService.LeaveChannel(currentChannel);
        }

        isPrivateConversation = false;
        selectedPrivateUser = null;
        privateMessages.Clear();

        currentChannel = channel;
        await LoadMessages();
        await ChatService.JoinChannel(currentUsername, channel);

        var channelInfo = channels.FirstOrDefault(c => c.Name == channel);
        isCurrentChannelMuted = channelInfo?.IsMuted ?? false;
        sidebarOpen = false;
    }

    private async Task LoadChannels()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<Channel>>("/api/channels");
            if (result != null)
            {
                channels = result;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des canaux");
        }
    }

    private async Task LoadMessages()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<List<Message>>($"/api/messages/{currentChannel}");
            if (result != null)
            {
                messages = result;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du chargement des messages pour le canal {Channel}", currentChannel);
        }
    }

    private async Task SendMessage(string content)
    {
        if (!string.IsNullOrEmpty(currentUsername) && isConnected)
        {
            var req = new SendMessageRequest
            {
                Username = currentUsername,
                Content = content,
                Channel = currentChannel
            };

            try
            {
                await ChatService.SendMessage(req);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Erreur lors de l'envoi du message");
            }
        }
    }

    private async Task HandleUserClicked(string username)
    {
        if (username != currentUsername)
        {
            await OpenPrivateChat(username);
        }
    }

    // Méthodes pour messages privés
    private async Task LoadPrivateConversations()
    {
        privateConversations = await PrivateMessageService.GetConversationsAsync(currentUsername);
    }

    private async Task OpenPrivateChat(string username)
    {
        if (!string.IsNullOrEmpty(currentChannel) && !isPrivateConversation)
        {
            await ChatService.LeaveChannel(currentChannel);
        }

        currentChannel = "";
        isPrivateConversation = true;
        selectedPrivateUser = username;

        privateMessages = await PrivateMessageService.GetPrivateMessagesAsync(currentUsername, username);
        await ChatService.MarkPrivateMessagesAsRead(username);
        await LoadPrivateConversations();

        sidebarOpen = false;
        StateHasChanged();
    }

    private void ClosePrivateChat()
    {
        isPrivateConversation = false;
        selectedPrivateUser = null;
        privateMessages.Clear();
        StateHasChanged();
    }

    private async Task SendPrivateMessage(string content)
    {
        if (string.IsNullOrEmpty(selectedPrivateUser) || !isConnected)
        {
            return;
        }

        var request = new SendPrivateMessageRequest
        {
            SenderUsername = currentUsername,
            RecipientUsername = selectedPrivateUser,
            Content = content
        };

        try
        {
            await ChatService.SendPrivateMessage(request);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de l'envoi du message privé à {Recipient}", selectedPrivateUser);
        }
    }

    private async Task DeleteConversation(string otherUsername)
    {
        var success = await PrivateMessageService.DeleteConversationAsync(currentUsername, otherUsername);

        if (success)
        {
            if (selectedPrivateUser == otherUsername && isPrivateConversation)
            {
                ClosePrivateChat();
            }

            await LoadPrivateConversations();
            StateHasChanged();
        }
    }

    private async Task HandleMuteStatusChanged(bool isMuted)
    {
        isCurrentChannelMuted = isMuted;
        await LoadChannels();
        StateHasChanged();
    }

    private bool CanManageCurrentChannel()
    {
        if (string.IsNullOrEmpty(currentChannel) || isPrivateConversation)
        {
          return false;
        }

        var channel = channels.FirstOrDefault(c => c.Name == currentChannel);
        if (channel == null) return false;

        bool isCreator = channel.CreatedBy.Equals(currentUsername, StringComparison.OrdinalIgnoreCase);
        bool isAdmin = Auth.IsAdmin;

        return isCreator || isAdmin;
    }

    private void HandleSidebarToggle(bool newState)
    {
        sidebarOpen = newState;
        StateHasChanged();
    }

    private void HandleUsersListToggle(bool newState)
    {
        usersListOpen = newState;
        StateHasChanged();
    }

    private string GetCurrentChannelOrUsername()
    {
        return isPrivateConversation ? selectedPrivateUser ?? "" : currentChannel;
    }

    private List<Message> GetCurrentMessages()
    {
        if (isPrivateConversation)
        {
            // Convertir les PrivateMessage en Message pour l'affichage
            return privateMessages.Select(pm => new Message
            {
                Id = pm.Id,
                Username = pm.SenderUsername,
                Content = pm.Content,
                Timestamp = pm.Timestamp
            }).ToList();
        }
        return messages;
    }

    public async ValueTask DisposeAsync()
    {
        ChatService.OnMessageReceived -= OnMessageReceived;
        ChatService.OnUserJoined -= OnUserJoined;
        ChatService.OnUserLeft -= OnUserLeft;
        ChatService.OnUserListUpdated -= OnUserListUpdated;
        ChatService.OnChannelMuteStatusChanged -= OnChannelMuteStatusChanged;
        ChatService.OnMessageBlocked -= OnMessageBlocked;
        ChatService.OnChannelDeleted -= OnChannelDeleted;
        ChatService.OnChannelNotFound -= OnChannelNotFound;
        ChatService.OnChannelListUpdated -= OnChannelListUpdated;

        PrivateMessageService.OnPrivateMessageReceived -= OnPrivateMessageReceived;
        PrivateMessageService.OnPrivateMessageSent -= OnPrivateMessageSent;
        PrivateMessageService.OnUnreadCountChanged -= OnUnreadCountChanged;
        PrivateMessageService.OnConversationDeleted -= OnConversationDeleted;

        await ChatService.DisposeAsync();

        GC.SuppressFinalize(this);
    }
}
