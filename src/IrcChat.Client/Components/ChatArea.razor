@* src/IrcChat.Client/Components/ChatArea.razor *@
@using IrcChat.Shared.Models

<div class="chat-main">
    @if (string.IsNullOrEmpty(CurrentChannel))
    {
        <div class="welcome">
            <h2>Bienvenue @Username!</h2>
            <p>Cr√©ez ou rejoignez un salon pour commencer √† chatter.</p>
        </div>
    }
    else
    {
        <div class="chat-header">
            <div class="header-left">
                @if (IsPrivateConversation)
                {
                    <h2>üí¨ @CurrentChannel</h2>
                    <span class="user-status @(IsUserOnline ? "online" : "offline")">
                        <span class="status-indicator"></span>
                        <span class="status-indicator-text">@(IsUserOnline ? "En ligne" : "Hors ligne")</span>
                    </span>
                    <IgnoreUserButton UserId="@CurrentContactUserId" />
                    <GlobalMuteUserButton UserId="@CurrentContactUserId" />
                }
                else
                {
                    <div class="channel-title-section">
                        <h2 class="channel-title">
                            <span class="channel-hash">#@CurrentChannel</span>
                        </h2>
                        <span class="status @(IsConnected ? "connected" : "disconnected")">
                            @(IsConnected ? "‚óè" : "‚óã")
                        </span>
                        <span class="status-text @(IsConnected ? "connected" : "disconnected")">
                            @(IsConnected ? "Connect√©" : "D√©connect√©")
                        </span>
                        @if (CanManage && !string.IsNullOrEmpty(CurrentChannel))
                        {
                            <button class="edit-channel-btn" @onclick="OpenEditModal" title="Modifier la description">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                </svg>
                            </button>
                        }
                    </div>
                    @if (!string.IsNullOrEmpty(ChannelDescription))
                    {
                        <div class="channel-description-container">
                            <p class="channel-description @(isDescriptionExpanded ? "expanded" : "")"
                               title="@ChannelDescription">
                                @ChannelDescription
                            </p>
                            @if (ChannelDescription.Length > 80)
                            {
                                <button class="description-toggle" @onclick="ToggleDescription">
                                    @(isDescriptionExpanded ? "Moins" : "Plus")
                                </button>
                            }
                        </div>
                    }
                }
            </div>
            <div class="header-right">
                @if (IsPrivateConversation)
                {
                    <button class="close-btn" @onclick="OnClosePrivateConversation" title="Fermer la conversation">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        <span>Fermer</span>
                    </button>
                }
                else
                {
                    <UsersListToggleButton IsOpen="@UsersListOpen"
                                           UserCount="@(Users?.Count ?? 0)"
                                           OnToggle="OnUsersListToggle" />

                    <ChannelMuteButton ChannelName="@CurrentChannel"
                                       IsMuted="@IsMuted"
                                       CanManage="@CanManage"
                                       OnMuteStatusChanged="OnMuteStatusChanged" />
                    <ChannelDeleteButton ChannelName="@CurrentChannel"
                                         CanManage="@CanManage"
                                         OnChannelDeleted="OnChannelDeleted" />
                }
            </div>
        </div>

        <div class="chat-content @(UsersListOpen ? "users-open" : "users-closed")">
            <div class="chat-messages">
                <MessageList Messages="Messages"
                             CurrentUsername="@Username"
                             OnUsernameClicked="HandleUsernameClicked" />

                <MessageInput @ref="messageInputRef"
                              IsConnected="IsConnected"
                              AvailableUsers="@Users"
                              OnSendMessage="OnMessageSent" />
            </div>

            @if (Users != null)
            {
                <div class="chat-users @(UsersListOpen ? "visible" : "hidden")">
                    <ChannelUsersList Users="@Users"
                                      ChannelName="@CurrentChannel"
                                      Username="@Username"
                                      CanModifyChannel="@CanManage"
                                      OnUserClicked="OnUserClicked" />
                </div>
            }
        </div>
    }

    @if (showEditModal && !IsPrivateConversation && CanManage && !string.IsNullOrEmpty(CurrentChannel))
    {
        <ChannelEditModal ChannelName="@CurrentChannel"
                          CurrentDescription="@ChannelDescription"
                          OnClose="CloseEditModal"
                          OnSaved="HandleChannelSaved" />
    }

</div>

@code {
    private MessageInput? messageInputRef;

    [Parameter]
    public string Username { get; set; } = string.Empty;

    [Parameter]
    public string CurrentContactUserId { get; set; } = string.Empty;

    [Parameter]
    public string? CurrentChannel { get; set; }

    [Parameter]
    public bool IsConnected { get; set; }

    [Parameter]
    public List<Message> Messages { get; set; } = new();

    [Parameter]
    public List<User>? Users { get; set; }

    [Parameter]
    public bool IsMuted { get; set; }

    [Parameter]
    public bool CanManage { get; set; }

    [Parameter]
    public bool UsersListOpen { get; set; }

    [Parameter]
    public bool IsPrivateConversation { get; set; }

    [Parameter]
    public bool IsUserOnline { get; set; }

    [Parameter]
    public string? ChannelDescription { get; set; }

    [Parameter]
    public EventCallback<string> OnMessageSent { get; set; }

    [Parameter]
    public EventCallback<User> OnUserClicked { get; set; }

    [Parameter]
    public EventCallback<bool> OnMuteStatusChanged { get; set; }

    [Parameter]
    public EventCallback<string> OnChannelDeleted { get; set; }

    [Parameter]
    public EventCallback<bool> OnUsersListToggle { get; set; }

    [Parameter]
    public EventCallback OnClosePrivateConversation { get; set; }

    [Parameter]
    public EventCallback OnChannelUpdated { get; set; }

    private bool showEditModal = false;
    private bool isDescriptionExpanded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(CurrentChannel) && IsConnected)
        {
            await FocusInputAsync();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Focus sur l'input quand on change de canal ou de conversation
        await FocusInputAsync();
    }

    private async Task FocusInputAsync()
    {
        if (messageInputRef != null)
        {
            await Task.Delay(100); // Petit d√©lai pour s'assurer que le composant est rendu
            await messageInputRef.FocusAsync();
        }
    }

    private void OpenEditModal()
    {
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
    }

    private async Task HandleChannelSaved()
    {
        await OnChannelUpdated.InvokeAsync();
        CloseEditModal();
    }

    private void ToggleDescription()
    {
        isDescriptionExpanded = !isDescriptionExpanded;
    }

    private void HandleUsernameClicked(string username)
    {
        // Ins√©rer le pseudo dans le champ de saisie
        messageInputRef?.InsertUsername(username);
        // Remettre le focus sur l'input apr√®s insertion
        _ = FocusInputAsync();
    }
}
