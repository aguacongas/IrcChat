@using IrcChat.Client.Services
@using IrcChat.Shared.Models
@using System.Net.Http.Json
@inject IIgnoredUsersService IgnoredUsersService
@inject HttpClient HttpClient
@inject ILogger<ChannelUsersList> Logger
@inject NavigationManager Navigation

<div class="channel-users-list">
    @if (Users?.Any() == true)
    {
        <h4>Utilisateurs (@Users.Count)</h4>
        <ul class="users-list">
            @foreach (var user in Users!)
            {
                <li class="user-item @(IgnoredUsersService.IsUserIgnored(user.UserId) ? "ignored" : string.Empty) @(user.Username == Username ? "current" : string.Empty)"
                    @onclick="() => OnUserClicked.InvokeAsync(user)">
                    <span class="user-name">@user.Username</span>

                    @if (IgnoredUsersService.IsUserIgnored(user.UserId))
                    {
                        <span class="ignore-indicator" title="Vous ignorez cet utilisateur">üö´</span>
                    }

                    @if (CanModifyChannel && user.Username != Username && !IsMutedUser(user.UserId))
                    {
                        <button class="btn-mute"
                                @onclick="(MouseEventArgs e) => MuteUserAsync(user, ChannelName, e)"
                                @onclick:stopPropagation="true"
                                title="Rendre mute cet utilisateur"
                                disabled="@_isMuting">
                            @if (_isMuting && _mutingUserId == user.UserId)
                            {
                                <span>‚è≥</span>
                            }
                            else
                            {
                                <span>üîá</span>
                            }
                        </button>
                    }
                    else if (CanModifyChannel && user.Username != Username && IsMutedUser(user.UserId))
                    {
                        <button class="btn-unmute"
                                @onclick="(MouseEventArgs e) => UnmuteUserAsync(user, ChannelName, e)"
                                @onclick:stopPropagation="true"
                                title="Retirer le mute de cet utilisateur"
                                disabled="@_isMuting">
                            @if (_isMuting && _mutingUserId == user.UserId)
                            {
                                <span>‚è≥</span>
                            }
                            else
                            {
                                <span>üîä</span>
                            }
                        </button>
                    }
                </li>
            }
        </ul>
    }
    else
    {
        <div class="empty-state">Aucun utilisateur connect√©</div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-message">@_errorMessage</div>
    }

    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="success-message">@_successMessage</div>
    }
</div>

@code {
    [Parameter]
    [EditorRequired]
    public List<User> Users { get; set; } = [];

    [Parameter]
    [EditorRequired]
    public string ChannelName { get; set; } = string.Empty;

    [Parameter]
    public string Username { get; set; } = string.Empty;

    [Parameter]
    public bool CanModifyChannel { get; set; }

    [Parameter]
    public EventCallback<User> OnUserClicked { get; set; }

    private List<string> _mutedUserIds = [];
    private bool _isMuting;
    private string _mutingUserId = string.Empty;
    private string _errorMessage = string.Empty;
    private string _successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await IgnoredUsersService.InitializeAsync();
            await LoadMutedUsersAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de l'initialisation du composant");
            _errorMessage = "Erreur lors du chargement des utilisateurs mut√©s";
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(ChannelName))
        {
            await LoadMutedUsersAsync();
        }
    }

    private async Task LoadMutedUsersAsync()
    {
        try
        {
            var response = await HttpClient.GetAsync($"/api/channels/{Uri.EscapeDataString(ChannelName)}/muted-users");

            if (response.IsSuccessStatusCode)
            {
                var mutedUsers = await response.Content.ReadFromJsonAsync<List<MutedUserResponse>>();
                _mutedUserIds = mutedUsers?
                    .Select(m => m.UserId)
                    .ToList() ?? [];
            }
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Erreur lors du chargement de la liste des utilisateurs mut√©s");
        }
    }

    private bool IsMutedUser(string userId) => _mutedUserIds.Contains(userId);

    private async Task MuteUserAsync(User user, string channelName, MouseEventArgs e)
    {
        if (_isMuting)
        {
            return;
        }

        _isMuting = true;
        _mutingUserId = user.UserId;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        try
        {
            var response = await HttpClient.PostAsJsonAsync(
                $"/api/channels/{Uri.EscapeDataString(channelName)}/muted-users/{Uri.EscapeDataString(user.UserId)}",
                new { reason = string.Empty });

            if (response.IsSuccessStatusCode)
            {
                _mutedUserIds.Add(user.UserId);
                _successMessage = $"{user.Username} a √©t√© rendu muet dans le salon";

                StateHasChanged();

                // Effacer le message apr√®s 3 secondes
                await Task.Delay(3000);
                _successMessage = string.Empty;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Logger.LogError("Erreur lors du mute: {Error}", error);
                _errorMessage = "Impossible de rendre l'utilisateur muet";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors du mute de {Username}", user.Username);
            _errorMessage = "Une erreur s'est produite lors du mute";
        }
        finally
        {
            _isMuting = false;
            _mutingUserId = string.Empty;
        }
    }

    private async Task UnmuteUserAsync(User user, string channelName, MouseEventArgs e)
    {
        if (_isMuting)
        {
            return;
        }

        _isMuting = true;
        _mutingUserId = user.UserId;
        _errorMessage = string.Empty;
        _successMessage = string.Empty;

        try
        {
            var response = await HttpClient.DeleteAsync(
                $"/api/channels/{Uri.EscapeDataString(channelName)}/muted-users/{Uri.EscapeDataString(user.UserId)}");

            if (response.IsSuccessStatusCode)
            {
                _mutedUserIds.Remove(user.UserId);
                _successMessage = $"{user.Username} peut √† nouveau parler dans le salon";

                StateHasChanged();

                // Effacer le message apr√®s 3 secondes
                await Task.Delay(3000);
                _successMessage = string.Empty;
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Logger.LogError("Erreur lors de l'unmute: {Error}", error);
                _errorMessage = "Impossible de retirer le mute de l'utilisateur";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Erreur lors de l'unmute de {Username}", user.Username);
            _errorMessage = "Une erreur s'est produite lors du retrait du mute";
        }
        finally
        {
            _isMuting = false;
            _mutingUserId = string.Empty;
        }
    }
}
