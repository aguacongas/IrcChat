name: Auto Label PR

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-label:
    name: Auto Label Based on Commits
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout PR
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
        fetch-depth: 0

    - name: ğŸ” Analyze commits and add labels
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo } = context.repo;
          const prNumber = context.payload.pull_request.number;
          
          // RÃ©cupÃ©rer tous les commits de la PR
          const { data: commits } = await github.rest.pulls.listCommits({
            owner,
            repo,
            pull_number: prNumber
          });
          
          // Analyser les messages de commits
          const commitMessages = commits.map(c => c.commit.message);
          console.log('Commit messages:', commitMessages);
          
          // DÃ©terminer les labels selon les conventional commits
          const labels = new Set();
          
          commitMessages.forEach(msg => {
            const lower = msg.toLowerCase();
            
            // Features
            if (lower.startsWith('feat:') || lower.startsWith('feat(')) {
              labels.add('feature');
              labels.add('enhancement');
            }
            
            // Bug fixes
            if (lower.startsWith('fix:') || lower.startsWith('fix(')) {
              labels.add('bug');
              labels.add('fix');
            }
            
            // Documentation
            if (lower.startsWith('docs:') || lower.startsWith('docs(')) {
              labels.add('documentation');
              labels.add('docs');
            }
            
            // Tests
            if (lower.startsWith('test:') || lower.startsWith('test(')) {
              labels.add('test');
              labels.add('tests');
            }
            
            // Performance
            if (lower.startsWith('perf:') || lower.startsWith('perf(')) {
              labels.add('performance');
              labels.add('perf');
            }
            
            // Refactoring
            if (lower.startsWith('refactor:') || lower.startsWith('refactor(')) {
              labels.add('refactor');
            }
            
            // Style
            if (lower.startsWith('style:') || lower.startsWith('style(')) {
              labels.add('style');
            }
            
            // Chore/Maintenance
            if (lower.startsWith('chore:') || lower.startsWith('chore(')) {
              labels.add('chore');
            }
            
            // Dependencies
            if (lower.includes('dependencies') || lower.includes('deps:')) {
              labels.add('dependencies');
            }
            
            // Security
            if (lower.includes('security') || lower.startsWith('security:')) {
              labels.add('security');
            }
            
            // Breaking changes
            if (lower.includes('breaking change') || lower.includes('!:')) {
              labels.add('breaking-change');
            }
          });
          
          const labelsArray = Array.from(labels);
          console.log('Labels to add:', labelsArray);
          
          if (labelsArray.length > 0) {
            // Ajouter les labels
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: prNumber,
              labels: labelsArray
            });
            
            // Ajouter un commentaire explicatif
            const labelsList = labelsArray.map(l => `\`${l}\``).join(', ');
            const body = `ğŸ¤– **Labels ajoutÃ©s automatiquement** : ${labelsList}

BasÃ© sur l'analyse des messages de commits.

ğŸ’¡ **Vous pouvez modifier ces labels** avant de merger la PR pour ajuster le changelog de la prochaine release.

ğŸ“‹ Labels disponibles pour le changelog :
- \`feature\`, \`enhancement\` â†’ âœ¨ Features
- \`bug\`, \`fix\` â†’ ğŸ› Bug Fixes  
- \`documentation\`, \`docs\` â†’ ğŸ“ Documentation
- \`test\`, \`tests\` â†’ ğŸ§ª Tests
- \`chore\`, \`dependencies\` â†’ ğŸ”§ Maintenance
- \`performance\`, \`perf\` â†’ ğŸš€ Performance
- \`security\` â†’ ğŸ”’ Security`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: body
            });
          } else {
            // Aucun label dÃ©tectÃ©, ajouter un commentaire d'avertissement
            const warningBody = `âš ï¸ **Aucun label automatique dÃ©tectÃ©**

Les commits de cette PR ne suivent pas le format [Conventional Commits](https://www.conventionalcommits.org/).

**Exemples de formats reconnus :**
\`\`\`
feat: add user ban system
fix: correct message display
docs: update README
test: add integration tests
chore: update dependencies
\`\`\`

ğŸ’¡ **Ajoutez manuellement un label** pour que cette PR apparaisse dans le changelog :
- \`feature\` â†’ âœ¨ Features
- \`bug\` â†’ ğŸ› Bug Fixes
- \`documentation\` â†’ ğŸ“ Documentation
- \`test\` â†’ ğŸ§ª Tests
- \`chore\` â†’ ğŸ”§ Maintenance`;

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: warningBody
            });
          }

    - name: ğŸ“Š Summary
      if: always()
      run: |
        echo "âœ… Auto-labeling completed!"
        echo "Check the PR for added labels and bot comment."
