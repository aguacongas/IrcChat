name: Update Emoji Data

on:
  # ExÃ©cution manuelle
  workflow_dispatch:
  
  # ExÃ©cution automatique le 1er de chaque mois Ã  2h du matin
  schedule:
    - cron: '0 2 1 * *'
  
  # ExÃ©cution sur push de tags de release (optionnel)
  push:
    tags:
      - 'v*.*.*'

jobs:
  update-emojis:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Generate emoji data
        run: |
          cd scripts
          node generate-emoji-data.js
        
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet src/IrcChat.Client/wwwroot/data/emojis.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… Aucun changement dÃ©tectÃ© dans emojis.json"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Changements dÃ©tectÃ©s dans emojis.json"
          fi
      
      - name: Get emoji statistics
        if: steps.check_changes.outputs.has_changes == 'true'
        id: stats
        run: |
          EMOJI_COUNT=$(jq '.emojis | length' src/IrcChat.Client/wwwroot/data/emojis.json)
          CATEGORY_COUNT=$(jq '.categories | length' src/IrcChat.Client/wwwroot/data/emojis.json)
          VERSION=$(jq -r '.version' src/IrcChat.Client/wwwroot/data/emojis.json)
          
          echo "emoji_count=$EMOJI_COUNT" >> $GITHUB_OUTPUT
          echo "category_count=$CATEGORY_COUNT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Statistiques:"
          echo "  - Version Unicode: $VERSION"
          echo "  - Emojis: $EMOJI_COUNT"
          echo "  - CatÃ©gories: $CATEGORY_COUNT"
      
      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore(emojis): update emoji data from Unicode CLDR'
          title: 'ðŸ”„ Update Emoji Data (Unicode ${{ steps.stats.outputs.version }})'
          body: |
            ## ðŸ“¦ Mise Ã  jour automatique des donnÃ©es emoji
            
            Cette PR a Ã©tÃ© gÃ©nÃ©rÃ©e automatiquement par le workflow `update-emojis.yml`.
            
            ### ðŸ“Š Statistiques
            
            - **Version Unicode**: ${{ steps.stats.outputs.version }}
            - **Nombre d'emojis**: ${{ steps.stats.outputs.emoji_count }}
            - **Nombre de catÃ©gories**: ${{ steps.stats.outputs.category_count }}
            
            ### ðŸ” Source
            
            Les donnÃ©es proviennent de [Unicode CLDR](https://github.com/unicode-org/cldr-json) (Common Locale Data Repository).
            
            ### âœ… VÃ©rifications
            
            - [x] DonnÃ©es gÃ©nÃ©rÃ©es depuis Unicode CLDR officiel
            - [x] Format JSON validÃ©
            - [x] Statistiques vÃ©rifiÃ©es
            
            ### ðŸš€ Actions requises
            
            1. VÃ©rifier que le fichier `emojis.json` est valide
            2. Tester localement si nÃ©cessaire :
               ```bash
               cd scripts
               node generate-emoji-data.js
               ```
            3. Merger la PR si tout est OK
            
            ---
            
            **GÃ©nÃ©rÃ© le**: ${{ github.event.head_commit.timestamp }}  
            **Workflow**: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          branch: update-emojis-${{ github.run_number }}
          delete-branch: true
          labels: |
            automated
            emojis
            dependencies
          draft: false
      
      - name: Comment on issue (no changes)
        if: steps.check_changes.outputs.has_changes == 'false' && github.event_name == 'workflow_dispatch'
        run: |
          echo "â„¹ï¸ Aucun changement dÃ©tectÃ© dans les donnÃ©es emoji."
          echo "Les donnÃ©es sont dÃ©jÃ  Ã  jour."
      
      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "### ðŸ”„ Mise Ã  jour des emojis" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… Pull Request crÃ©Ã©e avec succÃ¨s" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Statistiques:**" >> $GITHUB_STEP_SUMMARY
            echo "- Version Unicode: ${{ steps.stats.outputs.version }}" >> $GITHUB_STEP_SUMMARY
            echo "- Emojis: ${{ steps.stats.outputs.emoji_count }}" >> $GITHUB_STEP_SUMMARY
            echo "- CatÃ©gories: ${{ steps.stats.outputs.category_count }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "### â„¹ï¸ Pas de mise Ã  jour nÃ©cessaire" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Les donnÃ©es emoji sont dÃ©jÃ  Ã  jour." >> $GITHUB_STEP_SUMMARY
          fi